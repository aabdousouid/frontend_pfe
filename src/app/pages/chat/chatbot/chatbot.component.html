<div class="cv-chatbot-container">
      <p-card>
        <ng-template pTemplate="header">
          <div class="chatbot-header">
            <div class="flex align-items-center gap-2">
              <p-avatar 
                icon="pi pi-user" 
                styleClass="mr-2"
                [style]="{'background-color': '#10b981', 'color': '#ffffff'}">
              </p-avatar>
              <div>
                <h3 class="m-0">ACTIA-RecrutBot</h3>
                <small class="text-500">Assistant intelligent de recrutement</small>
              </div>
            </div>
            <p-badge 
              [value]="isOnline ? 'Online' : 'Offline'" 
              [severity]="isOnline ? 'success' : 'danger'">
            </p-badge>
          </div>
        </ng-template>

        <ng-template pTemplate="content">
          <!-- Chat Messages -->
          <div class="chat-messages" #chatContainer>
            <p-scrollPanel [style]="{width: '100%', height: '400px'}">
              <div class="messages-container">
                <div 
                  *ngFor="let message of messages;"
                  class="message-wrapper"
                  [ngClass]="{'user-message': message.sender === 'user', 'bot-message': message.sender === 'bot'}">
                  
                  <!-- User Messages -->
                  <div *ngIf="message.sender === 'user'" class="message user">
                    <div class="message-content">
                      <p *ngIf="message.type === 'text'">{{message.content}}</p>
                      <div *ngIf="message.type === 'file'" class="file-message">
                        <i class="pi pi-file-pdf text-red-500 mr-2"></i>
                        <span>{{message.content}}</span>
                      </div>
                    </div>
                    <small class="timestamp">{{message.timestamp | date:'short'}}</small>
                  </div>

                  <!-- Bot Messages -->
                  <div *ngIf="message.sender === 'bot'" class="message bot">
                    <p-avatar 
                      icon="pi pi-user" 
                      size="normal"
                      [style]="{'background-color': '#10b981', 'color': '#ffffff'}">
                    </p-avatar>
                    <div class="message-content">
                      <p *ngIf="message.type === 'text'">{{message.content}}</p>
                      <div *ngIf="message.context === 'jobTypeSelection' && message.suggestions!.length > 0" class="job-type-selection mt-3">
                      <p class="mb-2">Choisissez votre type de recherche : </p>
                      <div class="flex flex-wrap gap-2">
                        <div *ngIf="message.context === 'jobTypeSelection'" class="job-type-buttons">
                          <div class="flex flex-wrap gap-2">
                            <p-button 
                              *ngFor="let option of message.suggestions" 
                              [label]="option.label" 
                              (onClick)="onSelectJobType(option)" 
                              class="p-button-outlined">
                            </p-button>
                          </div>
                        </div>
                      </div>
                      
                    </div>

                      
                      <!-- Job Suggestions -->
                      <!-- inside *ngIf="message.type === 'suggestions'" -->
                    <div *ngIf="message.context === 'jobs' && message.suggestions!.length > 0" class="job-suggestions">
                      <h4 class="mb-3">Recommended Job Opportunities</h4>
                      <div class="grid">
                        <div 
                          *ngFor="let suggestion of message.suggestions" 
                          class="col-12 md:col-6 lg:col-4 mb-3">
                          
                          <p-card [header]="suggestion.title" subheader="{{suggestion.matchPercentage}}% Match" (click)="onSelectJob(suggestion.fullJob)">
                            <ng-template pTemplate="content">
                              <p class="mb-2"><strong>Description:</strong> {{suggestion.description}}</p>
                              <p class="mb-2"><strong>Experience Level:</strong> {{suggestion.experienceLevel}}</p>
                              <p class="mb-2"><strong>Contract :</strong> {{suggestion.type}}</p>
                              <p class="mb-2"><strong>Required Skills:</strong></p>
                              <div class="flex flex-wrap gap-2">
                                <p-chip *ngFor="let skill of suggestion.requiredSkills" [label]="skill"></p-chip>
                              </div>
                              <p class="mt-2 text-sm italic text-gray-500"><strong>Why:</strong> {{suggestion.justification}}</p>
                            </ng-template>
                          </p-card>
                        </div>
                      </div>
                    </div>

                    </div>
                    <small class="timestamp">{{message.timestamp | date:'short'}}</small>
                  </div>
                </div>


                <div *ngIf="quizCompleted && quizResult" class="quiz-result mt-4">
          <p-card header="Quiz Results" subheader="Evaluation Summary">
            <ng-template pTemplate="content">
              <p><strong>Score:</strong> {{quizResult.score.toFixed(1)}}%</p>
              <p><strong>Status:</strong> {{quizResult.status}}</p>
              <p><strong>Correct Answers:</strong> {{quizResult.correct_answers}} / {{quizResult.total_questions}}</p>

              <h5 class="mt-3">Category Breakdown:</h5>
              <ul>
                <li *ngFor="let c of categoryScoreKeys()">
                  {{c}}: {{quizResult.category_scores[c].toFixed(1)}}%
                </li>
              </ul>
              <p-button 
              *ngIf="quizResult?.status === 'RETRY'" 
              label="Retry Quiz" 
              icon="pi pi-refresh" 
              class="mt-2" 
              (onClick)="retryQuiz()">
            </p-button>
            <p-button 
              *ngIf="quizResult?.status === 'PASS'" 
              label="Postuler maintenant" 
              icon="pi pi-refresh" 
              class="mt-2" 
              (onClick)="apply()">
            </p-button>
            </ng-template>
          </p-card>
        </div>

                <!-- Typing Indicator -->
                <div *ngIf="isTyping" class="message bot typing-indicator">
                  <p-avatar 
                    icon="pi pi-user" 
                    size="normal"
                    [style]="{'background-color': '#10b981', 'color': '#ffffff'}">
                  </p-avatar>
                  <div class="message-content">
                    <div class="typing-dots">
                      <span></span>
                      <span></span>
                      <span></span>
                    </div>
                  </div>
                </div>
              </div>
            </p-scrollPanel>
          </div>


          <!-- === Quiz Section === -->
            <div *ngIf="quizInProgress && quizQuestions.length > 0" class="quiz-section mt-4">
              <h4 class="mb-3">Job Knowledge Quiz</h4>

              <p-card *ngFor="let q of quizQuestions; let i = index" class="mb-3">
              <ng-template pTemplate="content">
                <p class="font-bold">{{i + 1}}. {{q.question}}</p>

                <div class="flex flex-column gap-2 mt-2">
                  <div *ngFor="let opt of q.options; let j = index" class="flex align-items-center gap-2">
                    <p-radiobutton 
                      [inputId]="'q' + i + '_opt' + j" 
                      name="'q' + i" 
                      [value]="j" 
                      [(ngModel)]="quizAnswers[i]">
                    </p-radiobutton>
                    <label [for]="'q' + i + '_opt' + j">{{ opt }}</label>
                  </div>
                </div>

                <small class="text-muted">Category: {{q.category}} â€¢ Difficulty: {{q.difficulty}}</small>
              </ng-template>
            </p-card>


              <p-button 
                label="Submit Quiz" 
                icon="pi pi-check"
                class="mt-3"
                (onClick)="submitQuiz()"
                [disabled]="quizAnswers.includes(-1)">
              </p-button>
            </div>
          

            

          <!-- File Upload Section -->
          <div class="upload-section" *ngIf="!cvUploaded">
            <p-fileUpload 
              mode="advanced"
              accept=".pdf,.doc,.docx"
              [maxFileSize]="5000000"
              [showUploadButton]="false"
              [showCancelButton]="false"
              chooseLabel="Choose CV File"
              (onSelect)="onFileSelect($event)"
              (onRemove)="onFileRemove($event)">
              <ng-template pTemplate="content">
                <div class="upload-area">
                  <i class="pi pi-cloud-upload" style="font-size: 2rem; color: #10b981;"></i>
                  <p>Drag and drop your CV here or click to browse</p>
                  <small>Supported formats: PDF, DOC, DOCX (Max 5MB)</small>
                </div>
              </ng-template>
            </p-fileUpload>
          </div>

          <!-- Progress Bar -->
          <div *ngIf="isAnalyzing" class="analysis-progress">
            <p>Analyzing your CV...</p>
            <p-progressBar [value]="analysisProgress"></p-progressBar>
          </div>

          <!-- Chat Input -->
          <div class="chat-input">
            <div class="input-group">
              <input 
                type="text" 
                pInputText 
                [(ngModel)]="currentMessage" 
                placeholder="Ask me about your career opportunities..."
                (keyup.enter)="sendMessage()"
                [disabled]="!cvUploaded || isTyping"
                class="flex-1">
              <p-button 
                icon="pi pi-send" 
                (onClick)="sendMessage()"
                [disabled]="!currentMessage.trim() || !cvUploaded || isTyping"
                severity="primary">
              </p-button>
            </div>
          </div>
        </ng-template>
      </p-card>

      <p-toast></p-toast>
    </div>