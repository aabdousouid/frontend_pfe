<p-toast></p-toast>
<p-dialog 
  [(visible)]="display" 
  [breakpoints]="{ '960px': '90vw', '640px': '95vw' }" 
  [style]="{ width: '800px', maxWidth: '90vw', maxHeight: '90vh' }" 
  [modal]="true"
  [closable]="true"
  header=false
  [resizable]="false"
  [draggable]="false"
  styleClass="job-creation-dialog">
  
  <!-- Dialog Header -->
  <div class="dialog-header">
    <h2 class="dialog-title">Créer une nouvelle offre</h2>
    <p class="dialog-subtitle">Partagez votre opportunité avec les meilleurs talents</p>
  </div>

  <!-- Progress Stepper -->
  <div class="stepper-progress">
    <div class="progress-step" [class.completed]="activeStep > 1" [class.active]="activeStep === 1">
      <div class="step-circle">
        <i class="pi pi-user" *ngIf="activeStep === 1"></i>
        <i class="pi pi-check" *ngIf="activeStep > 1"></i>
        <span *ngIf="activeStep < 1">1</span>
      </div>
      <span>Informations de base</span>
    </div>
    <div class="progress-divider" [class.completed]="activeStep > 1"></div>
    
    <div class="progress-step" [class.completed]="activeStep > 2" [class.active]="activeStep === 2">
      <div class="step-circle">
        <i class="pi pi-star" *ngIf="activeStep === 2"></i>
        <i class="pi pi-check" *ngIf="activeStep > 2"></i>
        <span *ngIf="activeStep < 2">2</span>
      </div>
      <span>Compétences</span>
    </div>
    <div class="progress-divider" [class.completed]="activeStep > 2"></div>
    
    <div class="progress-step" [class.completed]="activeStep > 3" [class.active]="activeStep === 3">
      <div class="step-circle">
        <i class="pi pi-id-card" *ngIf="activeStep === 3"></i>
        <i class="pi pi-check" *ngIf="activeStep > 3"></i>
        <span *ngIf="activeStep < 3">3</span>
      </div>
      <span>Publication</span>
    </div>
  </div>

  <!-- Step 1: Basic Information -->
  <div class="step-content" *ngIf="activeStep === 1">
    <h3 class="step-title">Informations de base</h3>
    <div class="form-grid">
      <div class="form-group">
        <label class="form-label required">Titre du poste</label>
        <input 
          [(ngModel)]="form.title" 
          pInputText 
          class="form-input" 
          placeholder="Ex: Développeur Full Stack Senior"
          required>
      </div>
      
      <div class="form-group">
        <label class="form-label required">Entreprise</label>
        <input 
          [(ngModel)]="form.company" 
          pInputText 
          class="form-input" 
          placeholder="Nom de votre entreprise"
          required>
      </div>
      
      <div class="form-group">
        <label class="form-label required">Description du poste</label>
        <textarea 
          [(ngModel)]="form.description" 
          pTextarea 
          class="form-textarea"
          [autoResize]="true" 
          rows="4" 
          placeholder="Décrivez le poste, les missions principales et l'environnement de travail..."></textarea>
      </div>
    </div>
  </div>

  <!-- Step 2: Skills -->
  <div class="step-content" *ngIf="activeStep === 2">
    <h3 class="step-title">Compétences professionnelles requises</h3>
    <div class="skills-section">
      <div class="predefined-skills">
        <div class="skill-toggle" 
             *ngFor="let skill of toggleSkills" 
             [class.selected]="isSkillSelected(skill.model)"
             (click)="toggleSkill(skill.model)">
          {{skill.label}}
        </div>
      </div>
      
      <div class="custom-skill-section">
        <label class="form-label">Ajouter d'autres compétences</label>
        <div class="custom-skill-input">
          <input 
            type="text" 
            [(ngModel)]="customSkillInput"
            (keydown.enter)="addCustomSkill()"
            class="form-input" 
            placeholder="Ex: React, Kubernetes, AWS...">
          <p-button 
            (onClick)="addCustomSkill()" 
            icon="pi pi-plus" 
            label="Ajouter"
            styleClass="btn-add-skill">
          </p-button>
        </div>
        
        <div class="selected-skills" *ngIf="form.skills.length > 0">
          <div class="skill-chip" *ngFor="let skill of form.skills; let idx = index">
            {{skill}}
            <button class="remove-btn" (click)="removeSkill(idx)">&times;</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 3: Additional Information -->
  <div class="step-content" *ngIf="activeStep === 3">
    <h3 class="step-title">Détails et publication</h3>
    <div class="form-grid">
      <div class="info-grid">
        <div class="form-group">
          <label class="form-label required">Localisation</label>
          <p-select 
            [(ngModel)]="form.location" 
            [options]="dropdownValues" 
            optionLabel="name"
            placeholder="Sélectionner une localisation"
            class="form-select">
          </p-select>
        </div>
        
        <div class="form-group">
          <label class="form-label required">Type d'emploi</label>
          <p-select 
            [(ngModel)]="form.jobType" 
            [options]="dropdownValuesJob" 
            optionLabel="name"
            placeholder="Sélectionner le type"
            class="form-select">
          </p-select>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Niveau d'expérience requis</label>
        <input 
          [(ngModel)]="form.experience" 
          pInputText 
          class="form-input" 
          placeholder="Ex: 2-5 ans, Junior, Senior...">
      </div>
      
      <div class="form-group">
        <label class="form-label">Exigences spécifiques</label>
        <textarea 
          [(ngModel)]="form.requirements" 
          pTextarea 
          class="form-textarea"
          [autoResize]="true" 
          rows="3" 
          placeholder="Diplômes, certifications, expériences particulières..."></textarea>
      </div>
      
      <div class="form-group">
        <label class="form-label">Offre urgente</label>
        <div class="urgency-toggle" [class.urgent]="form.isUrgent">
          <div class="urgency-label">
            <i class="pi pi-exclamation-triangle urgency-icon"></i>
            Marquer comme urgent
          </div>
          <p-toggleSwitch [(ngModel)]="form.isUrgent"></p-toggleSwitch>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="step-actions">
    <p-button 
      *ngIf="activeStep > 1"
      (onClick)="previousStep()" 
      label="Précédent" 
      icon="pi pi-arrow-left"
      severity="secondary"
      styleClass="btn-secondary">
    </p-button>
    
    <div class="spacer" *ngIf="activeStep === 1"></div>
    
    <p-button 
      *ngIf="activeStep < 3"
      (onClick)="nextStep()" 
      label="Suivant" 
      icon="pi pi-arrow-right" 
      iconPos="right"
      styleClass="btn-primary">
    </p-button>
    
    <p-button 
      *ngIf="activeStep === 3"
      (onClick)="onsubmit()" 
      label="Publier l'offre" 
      icon="pi pi-check" 
      iconPos="left"
      styleClass="btn-success"
      [loading]="isSubmitting">
    </p-button>
  </div>
</p-dialog>
    <div class="job-list-container">
      <!-- Header Section -->
      <div class="header-section">
        <div class="title-section">
          <h1 class="main-title">Nos offres d'emploi et de stages</h1>
          <p class="subtitle">Découvrez les opportunités qui correspondent à vos compétences et à vos aspirations</p>
          
        </div>
        
        <!-- Search and Filters -->
        <p-card class="search-filter-section">
          @if(isAdmin==true) {
          <div style="padding: 2rem;">
          <p-button icon="pi pi-plus" severity="success" text raised rounded (onClick)="open()"/>
          </div>}
          <div class="search-bar">
            <span class="p-input-icon-left search-input-wrapper">
              <i class="pi pi-search"></i>
              <input 
                type="text" 
                pInputText 
                placeholder="Recherchez des emplois, des entreprises ou des keywords..." 
                [(ngModel)]="searchQuery"
                (input)="onSearchChange()"
                class="search-input"
              />
            </span>
          </div>
          
          <div class="filters-row">
            <div class="filter-group">
              <label class="filter-label">Localisation</label>
              <p-dropdown 
                [options]="filterOptions.locations"
                [(ngModel)]="selectedLocation"
                placeholder="All Locations"
                [showClear]="true"
                (onChange)="applyFilters()"
                class="filter-dropdown"
              ></p-dropdown>
            </div>
            
            <div class="filter-group">
              <label class="filter-label">Catégorie des offres</label>
              <p-dropdown 
                [options]="filterOptions.jobTypes"
                [(ngModel)]="selectedJobType"
                placeholder="All Types"
                [showClear]="true"
                (onChange)="applyFilters()"
                class="filter-dropdown"
              ></p-dropdown>
            </div>
            
            <div class="filter-group">
              <label class="filter-label">Experience</label>
              <p-dropdown 
                [options]="filterOptions.experienceLevels"
                [(ngModel)]="selectedExperience"
                placeholder="All Levels"
                [showClear]="true"
                (onChange)="applyFilters()"
                class="filter-dropdown"
              ></p-dropdown>
            </div>
            
            <div class="filter-group">
              <label class="filter-label">Skills</label>
              <p-multiSelect 
                [options]="filterOptions.skills"
                [(ngModel)]="selectedSkills"
                placeholder="Select Skills"
                [showClear]="true"
                (onChange)="applyFilters()"
                class="filter-multiselect"
                [maxSelectedLabels]="2"
              ></p-multiSelect>
            </div>
            
            <div class="filter-actions">
              <p-button 
                label="Clear All" 
                icon="pi pi-times" 
                [outlined]="true" 
                (onClick)="clearFilters()"
                class="clear-btn"
              ></p-button>
            </div>
          </div>
        </p-card>
      </div>

      <!-- Results Summary -->
      <div class="results-summary">
        <div class="results-info">
          <span class="results-count">{{ filteredJobs.length }}  Offres trouvées</span>
          <span class="results-text">• Mis à jour {{ lastUpdated | date:'short' }}</span>
        </div>
        
        <div class="sort-section">
          <label class="sort-label">Trier par :</label>
          <p-dropdown 
            [options]="sortOptions"
            [(ngModel)]="selectedSort"
            (onChange)="applySorting()"
            class="sort-dropdown"
          ></p-dropdown>
        </div>
      </div>

      <!-- Job Cards Grid -->
      <div class="jobs-grid" *ngIf="!loading; else loadingTemplate">
        <div class="job-card-wrapper" *ngFor="let job of paginatedJobs; trackBy: trackByJobId">
          <p-card class="job-card" [class.urgent-job]="job.isUrgent">
            <div class="job-card-header">
              <div class="company-info">
                <div class="company-logo" *ngIf="job.companyLogo">
                  <img [src]="job.companyLogo" [alt]="job.company + ' logo'" />
                </div>
                <div class="company-logo-placeholder" *ngIf="!job.companyLogo">
                  {{ job.company.charAt(0).toUpperCase() }}
                </div>
                <div class="job-title-info">
                  <h3 class="job-title">{{ job.title }}</h3>
                  <p class="company-name">{{ job.company }}</p>
                </div>
              </div>
              
              <div class="job-badges">
                <p-badge 
                  *ngIf="job.isUrgent" 
                  value="Urgent" 
                  severity="danger"
                  class="urgent-badge"
                ></p-badge>
                <p-tag 
                  [value]="job.jobType" 
                  [severity]="getJobTypeSeverity(job.jobType)"
                  class="job-type-tag"
                ></p-tag>
              </div>
            </div>

            <div class="job-details">
              <div class="job-meta">
                <span class="meta-item">
                  <i class="pi pi-map-marker"></i>
                  {{ job.location }}
                </span>
                <span class="meta-item">
                  <i class="pi pi-briefcase"></i>
                  {{ job.experience }}
                </span>
               <!--  <span class="meta-item">
                  <i class="pi pi-dollar"></i>
                  {{ job.salary }}
                </span> -->
                <span class="meta-item">
                  <i class="pi pi-calendar"></i>
                  {{ getTimeAgo(job.postedDate) }}
                </span>
              </div>

              <p class="job-description">{{ job.description }}</p>

              <div class="job-skills">
                <p-chip 
                  *ngFor="let skill of job.skills.slice(0, 4)" 
                  [label]="skill"
                  class="skill-chip"
                ></p-chip>
                <span *ngIf="job.skills.length > 4" class="more-skills">
                  +{{ job.skills.length - 4 }} more
                </span>
              </div>
            </div>

            <p-divider></p-divider>

            <div class="job-actions">
              <p-button 
                label="Voir les détails" 
                icon="pi pi-eye" 
                [outlined]="true"
                (onClick)="viewJobDetails(job.jobId)"
                class="view-btn"
              ></p-button>
             <!--  <p-button 
                label="View Details" 
                icon="pi pi-close" 
                [outlined]="true"
                (onClick)="deleteJob(job)"
                class="view-btn"
              ></p-button> -->
              <p-button *ngIf="!isAdmin"
                label="Postuler" 
                icon="pi pi-send"
                (click)="applyToJob(job.jobId)"
                class="apply-btn"
              ></p-button>

              <p-button *ngIf="isAdmin"
                label="Supprimer" 
                icon="pi pi-trash"
                (click)="deleteJob(job)"
                severity="danger"
              ></p-button>
            </div>
          </p-card>
        </div>
      </div>

      <!-- Loading Template -->
      <ng-template #loadingTemplate>
        <div class="jobs-skeleton">
          <div class="skeleton-card" *ngFor="let item of [1,2,3,4,5,6]">
            <p-skeleton height="200px"></p-skeleton>
          </div>
        </div>
      </ng-template>

      <!-- No Results -->
      <div class="no-results" *ngIf="filteredJobs.length === 0 && !loading">
        <i class="pi pi-search no-results-icon"></i>
        <h3>No jobs found</h3>
        <p>Try adjusting your search criteria or filters</p>
        <p-button 
          label="Clear Filters" 
          icon="pi pi-refresh" 
          (onClick)="clearFilters()"
          class="clear-all-btn"
        ></p-button>
      </div>

      <!-- Pagination -->
      <div class="pagination-wrapper" *ngIf="filteredJobs.length > 0">
        <p-paginator
          [rows]="itemsPerPage"
          [totalRecords]="filteredJobs.length"
          [first]="first"
          (onPageChange)="onPageChange($event)"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Showing {first} to {last} of {totalRecords} jobs"
        ></p-paginator>
      </div>
    </div>