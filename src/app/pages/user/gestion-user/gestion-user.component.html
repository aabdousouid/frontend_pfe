<div class="user-management-container">
  <!-- Header Card -->
  <p-card styleClass="header-card" [style]="{ 'margin-bottom':'1.5rem' }">
    <div class="header-content">
      <div class="header-text">
        <h1 class="main-title">Gestion des Utilisateurs</h1>
        <p class="subtitle">Gérez les utilisateurs de votre plateforme de recrutement</p>
      </div>
      <div class="header-stats">
        <div class="stat-item">
          <span class="stat-number">{{ totalUsers }}</span>
          <span class="stat-label">Total Utilisateurs</span>
        </div>
        <div class="stat-item">
          <span class="stat-number">{{ activeUsers }}</span>
          <span class="stat-label">Actifs</span>
        </div>
        <div class="stat-item">
          <span class="stat-number">{{ blockedUsers }}</span>
          <span class="stat-label">Bloqués</span>
        </div>
      </div>
    </div>
  </p-card>

  <!-- Toolbar -->
  <p-toolbar styleClass="toolbar-custom" [style]="{ 'margin-bottom': '1.5rem' }">
    <div class="toolbar-left">
      <p-button
        label="Nouvel Utilisateur"
        icon="pi pi-plus"
        styleClass="p-button-success"
        (click)="openNewUserDialog()">
      </p-button>
    </div>

    <div class="toolbar-right">
      <span class="p-input-icon-left search-container" [style]="{ 'margin-right': '1.5rem' }">
        <i class="pi pi-search"></i>
        <input
          type="text"
          pInputText
          
          placeholder="Rechercher utilisateur..."
          [(ngModel)]="searchTerm"
          (input)="onGlobalFilter($event)"
          class="search-input">
      </span>

      <p-dropdown [style]="{ 'margin-right': '1.5rem' }"
        [options]="statusOptions"
        [(ngModel)]="selectedStatus"
        placeholder="Filtrer par statut"
        [showClear]="true"
        optionLabel="label"
        optionValue="value"
        (onChange)="onStatusFilter()"
        styleClass="filter-dropdown">
      </p-dropdown>

      <p-dropdown 
        [options]="roleOptions"
        [(ngModel)]="selectedRole"
        placeholder="Filtrer par rôle"
        [showClear]="true"
        optionLabel="label"
        optionValue="value"
        (onChange)="onRoleFilter()"
        styleClass="filter-dropdown">
      </p-dropdown>
    </div>
  </p-toolbar>

  <!-- Users Table -->
  <p-card styleClass="table-card" [style]="{ 'margin-top': '1rem' }">
    <p-table
      #dt
      [value]="filteredUsers"
      [paginator]="true"
      [rows]="10"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} utilisateurs"
      [rowsPerPageOptions]="[10, 20, 50]"
      [globalFilterFields]="['firstName', 'lastName', 'email', 'role', 'department']"
      styleClass="p-datatable-striped">

      <ng-template pTemplate="header">
        <tr>
          <th>Utilisateur</th>
          <th>Email</th>
          <th>Rôle</th>
          <th>Département</th>
          <th>Statut</th>
          <th>Dernière Connexion</th>
          <th>Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-user>
        <tr>
          <td>
            <div class="user-info">
              <p-avatar
                [label]="(user.firstName.charAt(0) || '') + (user.lastName.charAt(0) || '')"
                styleClass="user-avatar"
                size="large"
                [style]="{'background-color': getAvatarColor(user.id)}">
              </p-avatar>
              <div class="user-details">
                <span class="user-name">{{ user.firstName }} {{ user.lastName }}</span>
                <small class="user-id">ID: {{ user.id }}</small>
              </div>
            </div>
          </td>

          <td>{{ user.email }}</td>

          <td>
            <p-tag
              [value]="user.role"
              [severity]="getRoleSeverity(user.role)"
              styleClass="role-tag">
            </p-tag>
          </td>

          <td>{{ user.department || '—' }}</td>

          <td>
            <p-tag
              [value]="getStatusLabel(user.status)"
              [severity]="getStatusSeverity(user.status)"
              [icon]="getStatusIcon(user.status)">
            </p-tag>
          </td>

          <td>{{ formatDate(user.lastLogin) }}</td>

          <td>
            <div class="action-buttons">
              <p-button
                icon="pi pi-eye"
                styleClass="p-button-rounded p-button-text p-button-info"
                pTooltip="Consulter"
                (click)="viewUser(user)">
              </p-button>

              <p-button
                icon="pi pi-pencil"
                styleClass="p-button-rounded p-button-text p-button-success"
                pTooltip="Modifier"
                (click)="editUser(user)">
              </p-button>

              <p-button
                [icon]="user.status === 'blocked' ? 'pi pi-unlock' : 'pi pi-lock'"
                [styleClass]="user.status === 'blocked' ? 'p-button-rounded p-button-text p-button-warning' : 'p-button-rounded p-button-text p-button-secondary'"
                [pTooltip]="user.status === 'blocked' ? 'Débloquer' : 'Bloquer'"
                (click)="toggleUserStatus(user)">
              </p-button>

              <p-button
                icon="pi pi-trash"
                styleClass="p-button-rounded p-button-text p-button-danger"
                pTooltip="Supprimer"
                (click)="deleteUser(user)">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="empty-message">
            <div class="empty-state">
              <i class="pi pi-users" style="font-size: 3rem; color: #6c757d;"></i>
              <p>Aucun utilisateur trouvé</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- User Details Dialog -->
  <p-dialog
    [(visible)]="userDetailsVisible"
    [style]="{width: '600px'}"
    header="Détails de l'Utilisateur"
    [modal]="true"
    styleClass="user-dialog">

    <div *ngIf="selectedUser" class="user-details-content">
      <div class="user-header">
        <p-avatar
          [label]="(selectedUser.firstName.charAt(0) || '') + (selectedUser.lastName.charAt(0) || '')"
          styleClass="large-avatar"
          size="xlarge"
          [style]="{'background-color': getAvatarColor(selectedUser.id)}">
        </p-avatar>
        <div class="user-info-detail">
          <h3>{{ selectedUser.firstName }} {{ selectedUser.lastName }}</h3>
          <p class="user-email">{{ selectedUser.email }}</p>
          <p-tag
            [value]="getStatusLabel(selectedUser.status)"
            [severity]="getStatusSeverity(selectedUser.status)">
          </p-tag>
        </div>
      </div>

      <div class="user-details-grid">
        <div class="detail-item">
          <label>ID Utilisateur:</label>
          <span>{{ selectedUser.id }}</span>
        </div>
        <div class="detail-item">
          <label>Rôle:</label>
          <span>{{ selectedUser.role }}</span>
        </div>
        <div class="detail-item">
          <label>Département:</label>
          <span>{{ selectedUser.department || '—' }}</span>
        </div>
        <div class="detail-item">
          <label>Date de création:</label>
          <span>{{ formatDate(selectedUser.createdAt) }}</span>
        </div>
        <div class="detail-item">
          <label>Dernière connexion:</label>
          <span>{{ formatDate(selectedUser.lastLogin) }}</span>
        </div>
      </div>
      

    </div>
    <p-button
    icon="pi pi-eye"
    styleClass="p-button-rounded p-button-text p-button-info"
    pTooltip="Voir profile"
    (click)="viewUserProfile(selectedUser?.id)">
              </p-button>
  </p-dialog>

  <!-- Edit User Dialog -->
  <p-dialog
    [(visible)]="editUserVisible"
    [style]="{width: '500px'}"
    header="Modifier l'Utilisateur"
    [modal]="true"
    styleClass="user-dialog">

    <form *ngIf="editingUser" class="edit-user-form">
      <div class="form-group">
        <label for="firstName">Prénom:</label>
        <input
          type="text"
          id="firstName"
          pInputText
          [(ngModel)]="editingUser.firstName"
          name="firstName"
          class="form-control">
      </div>

      <div class="form-group">
        <label for="lastName">Nom:</label>
        <input
          type="text"
          id="lastName"
          pInputText
          [(ngModel)]="editingUser.lastName"
          name="lastName"
          class="form-control">
      </div>

      <div class="form-group">
        <label for="email">Email:</label>
        <input
          type="email"
          id="email"
          pInputText
          [(ngModel)]="editingUser.email"
          name="email"
          class="form-control">
      </div>

      <div class="form-group">
        <label for="role">Rôle:</label>
        <p-dropdown
          [options]="roleOptions"
          [(ngModel)]="editingUser.role"
          optionLabel="label"
          optionValue="value"
          name="role"
          class="form-control">
        </p-dropdown>
      </div>

      <div class="form-group">
        <label for="department">Département:</label>
        <input
          type="text"
          id="department"
          pInputText
          [(ngModel)]="editingUser.department"
          name="department"
          class="form-control">
      </div>

      <div class="form-actions">
        <p-button
          label="Annuler"
          icon="pi pi-times"
          styleClass="p-button-text"
          (click)="editUserVisible = false">
        </p-button>
        <p-button
          label="Sauvegarder"
          icon="pi pi-check"
          styleClass="p-button-success"
          (click)="saveUser()">
        </p-button>
      </div>
    </form>
  </p-dialog>
</div>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>
